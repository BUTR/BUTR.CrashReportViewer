@page "/discord-oauth-callback"

@inject IDiscordClient _discordClient;
@inject ILocalStorageService _localStorage;
@inject NavigationManager _navigationManager;

<Text>@_message</Text>

@code {
    
    private string _message = string.Empty;
    
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        if (!await _localStorage.ContainKeyAsync("discord_state"))
        {
            _message = "State verification failed.";
            return;
        }

        var queries = _navigationManager.QueryString();
        var queryStatRaw = queries["state"];
        var queryCode = queries["code"];

        var state = await _localStorage.GetItemAsync<Guid>("discord_state");
        if (!Guid.TryParse(queryStatRaw, out var queryState) || state != queryState)
        {
            _message = "State verification failed.";
            return;
        }

        var tokens = await _discordClient.GetoauthtokensAsync(queryCode);
        await _discordClient.UpdatemetadataAsync(new UpdateMetadataRequest(tokens.AccessToken));
        _message = "You did it!  Now go back to Discord.";
    }

}