@attribute [Authorize(Roles = ApplicationRoles.Administrator)]
@page "/quartz-manager"

@inject IQuartzClient _quartzClient;

<Card Margin="Margin.Is4">
    <CardHeader>
        <CardTitle Size="4" Margin="Margin.Is0">Job History</CardTitle>
    </CardHeader>
    <CardBody>
        <DataGridPaging TItem="QuartzExecutionLogEntity"
                        @ref="@_dataGridRef"
                        DetailRowTrigger="@(x => x.Item.LogId == _dataGridRef.Value?.LogId)"
                        GetItems="@Paging">
            <DataGridColumns>
                <DataGridColumn TItem="QuartzExecutionLogEntity" Field="@nameof(QuartzExecutionLogEntity.JobName)" Caption="">
                    <DisplayTemplate>
                        @if (context.IsSuccess == true)
                        {
                            <Icon Name="IconName.CheckCircle" Style="@($"color: {Theme.ColorOptions.Success}")" />
                        }
                        else if (context.IsVetoed == true)
                        {
                            <Icon Name="IconName.MinusCircle" Style="@($"color: {Theme.ColorOptions.Warning}")" />
                        }
                        else if (context.IsException == true)
                        {
                            <Icon Name="IconName.TimesCircle" Style="@($"color: {Theme.ColorOptions.Danger}")" />
                        }
                        else
                        {
                            <Icon Name="IconName.Circle" Style="@($"color: {Theme.ColorOptions.Info}")" />
                        }
                    </DisplayTemplate>
                </DataGridColumn>
                <DataGridColumn TItem="QuartzExecutionLogEntity" Field="@nameof(QuartzExecutionLogEntity.MachineName)" Caption="Machine Name"/>
                <DataGridColumn TItem="QuartzExecutionLogEntity" Field="@nameof(QuartzExecutionLogEntity.JobName)" Caption="Job"/>
                <DataGridColumn TItem="QuartzExecutionLogEntity" Field="@nameof(QuartzExecutionLogEntity.TriggerName)" Caption="Trigger"/>
                <DataGridColumn TItem="QuartzExecutionLogEntity" Field="@nameof(QuartzExecutionLogEntity.ScheduleFireTimeUtc)" Caption="Schedule Fire Time"/>
                <DataGridColumn TItem="QuartzExecutionLogEntity" Field="@nameof(QuartzExecutionLogEntity.FireTimeUtc)" Caption="Actual Fire Time"/>
                <DataGridColumn TItem="QuartzExecutionLogEntity" Field="@nameof(QuartzExecutionLogEntity.JobRunTime)" Caption="Run Time"/>
            </DataGridColumns>
            <DetailRowTemplate>
                <Field>
                    <FieldLabel>Run Instance Id</FieldLabel>
                    <TextEdit Text="@context.RunInstanceId" Disabled  />
                </Field>
                <Field>
                    <FieldLabel>Retry Count</FieldLabel>
                    <TextEdit Text="@((context.RetryCount ?? 0).ToString())" Disabled  />
                </Field>
                <Field>
                    <FieldLabel>Result</FieldLabel>
                    <TextEdit Text="@context.Result" Disabled  />
                </Field>
                <Field>
                    <FieldLabel>Stack Trace</FieldLabel>
                    <MemoEdit Text="@(context.ExecutionLogDetail?.ErrorStackTrace ?? string.Empty)" AutoSize Disabled />
                </Field>
            </DetailRowTemplate>
        </DataGridPaging>
    </CardBody>
</Card>

@code {

    [CascadingParameter]
    protected Theme? Theme { get; set; }
    
    private DataGridPaging<QuartzExecutionLogEntity> _dataGridRef = default!;
    
    private async Task<DataGridPaging<QuartzExecutionLogEntity>.ItemsResponse?> Paging(int page, int pageSize, ICollection<Filtering> filters, ICollection<Sorting> sortings, CancellationToken ct) =>
        await _quartzClient.HistorypaginatedAsync(page, pageSize, ct) is { Data: { } data } ? new(data.Items, data.Metadata) : null;
}